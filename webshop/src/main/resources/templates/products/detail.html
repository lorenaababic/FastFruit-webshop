<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="hr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <title th:text="${product.name} + ' | FastFruit'">Detalji proizvoda | Fast Fruit</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<!-- Header -->
<div th:replace="~{fragments/header :: header}"></div>

<!-- Main Content -->
<main class="container my-5">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a th:href="@{/}">Početna</a></li>
      <li class="breadcrumb-item"><a th:href="@{/products}">Proizvodi</a></li>
      <li class="breadcrumb-item active" aria-current="page" th:text="${product.name}">Naziv proizvoda</li>
    </ol>
  </nav>

  <div class="row">
    <!-- Slika proizvoda -->
    <div class="col-lg-6 mb-4">
      <div class="product-gallery">
        <div class="main-image mb-3">
          <img th:src="@{${product.imagePath} != null ? '/images/' + ${product.imagePath} : '/images/placeholder.jpg'}"
               class="img-fluid rounded"
               th:alt="${product.name}">
        </div>
      </div>
    </div>

    <!-- Informacije o proizvodu -->
    <div class="col-lg-6">
      <h1 class="product-title mb-3" th:text="${product.name}">Naziv proizvoda</h1>

      <div class="product-meta mb-3">
        <span class="badge bg-primary" th:if="${product.category != null}" th:text="${product.category.name}">Kategorija</span>
      </div>

      <div class="product-price mb-4">
        <span class="h2" th:text="${#numbers.formatDecimal(product.price, 1, 2)} + ' €'">0.00 €</span>
        <div class="availability mt-2">
          <span th:if="${product.quantity > 0}" class="text-success">
            <i class="fas fa-check-circle"></i> Na skladištu
          </span>
          <span th:unless="${product.quantity > 0}" class="text-danger">
            <i class="fas fa-times-circle"></i> Nije dostupno
          </span>
        </div>
      </div>

      <div class="product-description mb-4" th:if="${product.description != null}">
        <h5>Opis proizvoda</h5>
        <p th:text="${product.description}">Opis proizvoda...</p>
      </div>

      <!-- Dodavanje u košaricu -->
      <form class="add-to-cart-form mb-4" th:attr="data-product-id=${product.id}">
        <div class="row g-3 align-items-center">
          <div class="col-auto">
            <label for="quantity" class="col-form-label">Količina:</label>
          </div>
          <div class="col-auto">
            <input type="number" id="quantity" name="quantity" class="form-control" value="1" min="1"
                   th:max="${product.quantity}">
          </div>
          <div class="col-auto">
            <button type="submit" class="btn btn-primary" th:disabled="${product.quantity <= 0}">
              <i class="fas fa-shopping-cart"></i> Dodaj u košaricu
            </button>
          </div>
        </div>
      </form>

      <!-- Info o dostavi i plaćanju -->
      <div class="additional-info">
        <div class="row">
          <div class="col-md-6">
            <h5>Plaćanje</h5>
            <ul class="list-unstyled">
              <li><i class="fas fa-money-bill-wave me-2"></i> Pouzećem</li>
              <li><i class="fab fa-paypal me-2"></i> PayPal</li>
            </ul>
          </div>
          <div class="col-md-6">
            <h5>Dostava</h5>
            <ul class="list-unstyled">
              <li><i class="fas fa-truck me-2"></i> Dostava 2-3 radna dana</li>
              <li><i class="fas fa-info-circle me-2"></i> Besplatna dostava iznad 50€</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Footer -->
<div th:replace="~{fragments/footer :: footer}"></div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script th:src="@{/js/main.js}"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute("content");
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute("content");

    // Cart functionality for product detail page
    const addToCartForm = document.querySelector('.add-to-cart-form');
    if (addToCartForm) {
      addToCartForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const productId = this.getAttribute('data-product-id');
        const quantity = document.getElementById('quantity').value;
        const submitBtn = this.querySelector('button[type="submit"]');

        // Show loading state
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Dodavanje...';
        submitBtn.disabled = true;

        // Use the API endpoint
        fetch(`/cart/api/add/${productId}?quantity=${quantity}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            [csrfHeader]: csrfToken
          }
        })
                .then(response => {
                  if (!response.ok) {
                    throw new Error('Network response was not ok');
                  }
                  return response.json();
                })
                .then(data => {
                  // Success notification
                  showNotification(`Dodano ${quantity} kom proizvoda u košaricu!`, 'success');

                  // Update cart counter in the header
                  updateCartCount();

                  // Restore button
                  submitBtn.innerHTML = originalText;
                  submitBtn.disabled = false;
                })
                .catch(error => {
                  console.error('Error:', error);
                  showNotification('Greška prilikom dodavanja u košaricu', 'danger');

                  // Restore button
                  submitBtn.innerHTML = originalText;
                  submitBtn.disabled = false;
                });
      });
    }

    // Helper function to update cart count
    function updateCartCount() {
      fetch('/cart/api/count')
              .then(response => response.json())
              .then(data => {
                const cartCounter = document.getElementById('cartItemCount');
                if (cartCounter) {
                  cartCounter.textContent = data.count;
                }
              })
              .catch(error => console.error('Error updating cart count:', error));
    }

    // Helper function to show notifications
    function showNotification(message, type) {
      const notification = document.createElement('div');
      notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
      notification.style.top = '20px';
      notification.style.right = '20px';
      notification.style.zIndex = '9999';
      notification.innerHTML = `
            <strong>${type === 'success' ? 'Uspjeh!' : 'Greška!'}</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;

      document.body.appendChild(notification);

      // Auto-dismiss after 3 seconds
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }
  });
</script>
</body>
</html>