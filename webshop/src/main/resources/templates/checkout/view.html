<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="hr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Plaƒáanje | FastFruit</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" th:href="@{/css/style.css}">

  <style>
    .payment-method-section {
      border: 2px solid transparent;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      transition: border-color 0.3s ease;
    }

    .payment-method-section.selected {
      border-color: #0d6efd;
      background-color: #f8f9fa;
    }

    .form-control.is-invalid {
      border-color: #dc3545;
    }

    .form-control.is-valid {
      border-color: #28a745;
    }

    .invalid-feedback {
      display: block;
    }
  </style>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<main class="container my-5">
  <h1>üí≥ Plaƒáanje</h1>

  <!-- Alert Messages -->
  <div class="alert alert-danger alert-dismissible fade show" th:if="${error != null}" role="alert">
    <i class="fas fa-exclamation-triangle me-2"></i>
    <span th:text="${error}">Poruka o gre≈°ci</span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>

  <div class="alert alert-success alert-dismissible fade show" th:if="${message != null}" role="alert">
    <i class="fas fa-check-circle me-2"></i>
    <span th:text="${message}">Poruka o uspjehu</span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>

  <!-- Dynamic Alert -->
  <div id="alert-container"></div>

  <div class="row">
    <!-- Left Column - Checkout Form -->
    <div class="col-md-7">
      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-shipping-fast me-2"></i>Podaci za dostavu</h5>
        </div>
        <div class="card-body">
          <form id="checkout-form" th:action="@{/checkout/process}" method="post">

            <!-- Customer Information -->
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="name" class="form-label">Ime i prezime *</label>
                <input type="text" class="form-control" id="name" name="name"
                       th:value="${user != null ? user.username : ''}"
                       placeholder="Unesite ime i prezime" required>
                <div class="invalid-feedback" id="name-error"></div>
              </div>
              <div class="col-md-6 mb-3">
                <label for="email" class="form-label">Email adresa *</label>
                <input type="email" class="form-control" id="email" name="email"
                       th:value="${user != null ? user.email : ''}"
                       placeholder="ime@example.com" required>
                <div class="invalid-feedback" id="email-error"></div>
              </div>
            </div>

            <div class="mb-4">
              <label for="shippingAddress" class="form-label">Adresa za dostavu *</label>
              <textarea class="form-control" id="shippingAddress" name="shippingAddress"
                        rows="3" placeholder="Unesite kompletnu adresu za dostavu (ulica, broj, grad, po≈°tanski broj)..." required></textarea>
              <div class="invalid-feedback" id="address-error"></div>
            </div>

            <!-- Payment Methods -->
            <div class="mb-4">
              <label class="form-label">Naƒçin plaƒáanja *</label>

              <div th:each="method : ${paymentMethods}">
                <div class="payment-method-section">
                  <div class="form-check">
                    <input class="form-check-input payment-method-radio" type="radio"
                           name="paymentMethod" th:id="${'payment-' + method}"
                           th:value="${method}" required>
                    <label class="form-check-label fw-bold" th:for="${'payment-' + method}">
                      <span th:if="${method.name() == 'PAYPAL'}">
                        <i class="fab fa-paypal text-primary me-2"></i>PayPal
                        <small class="text-muted d-block">Platite sigurno PayPal raƒçunom ili karticom</small>
                      </span>
                      <span th:if="${method.name() == 'CREDIT_CARD'}">
                        <i class="far fa-credit-card me-2"></i>Kreditna kartica
                        <small class="text-muted d-block">Direktno plaƒáanje karticom</small>
                      </span>
                      <span th:if="${method.name() == 'CASH_ON_DELIVERY'}">
                        <i class="fas fa-money-bill-wave text-success me-2"></i>Pouzeƒáe
                        <small class="text-muted d-block">Plaƒáanje pri dostavi</small>
                      </span>
                    </label>
                  </div>
                </div>
              </div>
              <div class="invalid-feedback" id="payment-error"></div>
            </div>

            <!-- PayPal Section -->
            <div id="paypal-section" style="display: none;">
              <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>PayPal plaƒáanje:</strong> Kliknite na PayPal dugme da zavr≈°ite plaƒáanje
              </div>

              <div id="paypal-button-container">
                <!-- PayPal buttons will be rendered here -->
              </div>
            </div>

            <!-- Traditional Submit Button -->
            <button type="submit" id="traditional-submit" class="btn btn-primary btn-lg w-100">
              <i class="fas fa-check me-2"></i>Potvrdi narud≈æbu
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Right Column - Order Summary -->
    <div class="col-md-5">
      <div class="card">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Va≈°a narud≈æba</h5>
        </div>
        <div class="card-body">
          <table class="table table-sm">
            <thead>
            <tr>
              <th>Proizvod</th>
              <th>Koliƒçina</th>
              <th class="text-end">Cijena</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="item : ${cartItems}">
              <td th:text="${item.product.name}">Proizvod</td>
              <td>
                <span class="badge bg-secondary" th:text="${item.quantity}">1</span>
              </td>
              <td class="text-end fw-bold"
                  th:text="${#numbers.formatDecimal(item.product.price.multiply(new java.math.BigDecimal(item.quantity)), 1, 2)} + ' ‚Ç¨'">
                0.00 ‚Ç¨
              </td>
            </tr>
            </tbody>
          </table>

          <div class="border-top pt-3">
            <div class="d-flex justify-content-between mb-2">
              <span>Ukupno proizvodi:</span>
              <span class="fw-bold" th:text="${#numbers.formatDecimal(total, 1, 2)} + ' ‚Ç¨'">0.00 ‚Ç¨</span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span>Dostava:</span>
              <span class="fw-bold" th:class="${freeShipping ? 'text-success' : ''}"
                    th:text="${freeShipping ? 'Besplatno' : #numbers.formatDecimal(shippingCost, 1, 2) + ' ‚Ç¨'}">5.00 ‚Ç¨</span>
            </div>
            <div class="text-muted small mb-2" th:if="${!freeShipping}">
              <i class="fas fa-info-circle text-primary"></i>
              Za besplatnu dostavu jo≈° <strong th:text="${#numbers.formatDecimal(50 - total, 1, 2)} + ' ‚Ç¨'"></strong>
            </div>
            <hr>
            <div class="d-flex justify-content-between fw-bold fs-4 text-primary">
              <span>Za platiti:</span>
              <span th:text="${#numbers.formatDecimal(finalAmount, 1, 2)} + ' ‚Ç¨'" id="totalAmount">0.00 ‚Ç¨</span>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-3 d-grid gap-2">
        <a th:href="@{/cart}" class="btn btn-outline-secondary">
          <i class="fas fa-arrow-left me-2"></i>Natrag na ko≈°aricu
        </a>
      </div>
    </div>
  </div>
</main>

<div th:replace="~{fragments/footer :: footer}"></div>

<!-- PayPal SDK -->
<script src="https://www.paypal.com/sdk/js?client-id=ARnDMj3w8Z2RaNhcq8f9NVmgzbMIRRG-pvbbvVPXbMZaMm4HUlFKtNewn-XqNVI4s8NA3HfEy4x5895L&currency=EUR&intent=capture&components=buttons"></script>

<script>
  console.log('üöÄ FastFruit PayPal Checkout');

  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('checkout-form');
    const paymentMethodRadios = document.querySelectorAll('.payment-method-radio');
    const paypalSection = document.getElementById('paypal-section');
    const traditionalSubmit = document.getElementById('traditional-submit');

    let paypalRendered = false;

    function validateField(fieldId, errorId, validator, errorMessage) {
      const field = document.getElementById(fieldId);
      const errorDiv = document.getElementById(errorId);
      const value = field.value?.trim() || '';

      if (validator(value)) {
        field.classList.remove('is-invalid');
        field.classList.add('is-valid');
        errorDiv.textContent = '';
        return true;
      } else {
        field.classList.remove('is-valid');
        field.classList.add('is-invalid');
        errorDiv.textContent = errorMessage;
        return false;
      }
    }

    function isValid() {
      console.log('üîç Starting validation...');

      const nameValid = validateField('name', 'name-error',
              value => value.length >= 2,
              'Ime mora imati najmanje 2 karaktera');

      const emailValid = validateField('email', 'email-error',
              value => value.includes('@') && value.length >= 5,
              'Email mora biti u ispravnom formatu');

      const addressValid = validateField('shippingAddress', 'address-error',
              value => value.length >= 10,
              'Adresa mora biti kompletna (minimum 10 karaktera)');

      const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
      const paymentValid = paymentMethod !== null;

      if (!paymentValid) {
        document.getElementById('payment-error').textContent = 'Odaberite naƒçin plaƒáanja';
      } else {
        document.getElementById('payment-error').textContent = '';
      }

      const allValid = nameValid && emailValid && addressValid && paymentValid;

      console.log('üîç Validation results:', {
        name: nameValid,
        email: emailValid,
        address: addressValid,
        payment: paymentValid,
        overall: allValid
      });

      return allValid;
    }

    ['name', 'email', 'shippingAddress'].forEach(fieldId => {
      document.getElementById(fieldId).addEventListener('blur', () => {
        if (fieldId === 'name') {
          validateField('name', 'name-error',
                  value => value.length >= 2,
                  'Ime mora imati najmanje 2 karaktera');
        } else if (fieldId === 'email') {
          validateField('email', 'email-error',
                  value => value.includes('@') && value.length >= 5,
                  'Email mora biti u ispravnom formatu');
        } else if (fieldId === 'shippingAddress') {
          validateField('shippingAddress', 'address-error',
                  value => value.length >= 10,
                  'Adresa mora biti kompletna (minimum 10 karaktera)');
        }
      });
    });

    function showAlert(message, type = 'danger') {
      const alertContainer = document.getElementById('alert-container');
      alertContainer.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          <i class="fas fa-${type === 'danger' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
    }

    paymentMethodRadios.forEach(radio => {
      radio.addEventListener('change', function() {
        console.log('Payment method:', this.value);

        document.getElementById('payment-error').textContent = '';

        if (this.value === 'PAYPAL') {
          paypalSection.style.display = 'block';
          traditionalSubmit.style.display = 'none';

          if (!paypalRendered) {
            renderPayPal();
          }
        } else {
          paypalSection.style.display = 'none';
          traditionalSubmit.style.display = 'block';
        }

        document.querySelectorAll('.payment-method-section').forEach(section => {
          section.classList.remove('selected');
        });
        this.closest('.payment-method-section').classList.add('selected');
      });
    });

    function renderPayPal() {
      console.log('Rendering PayPal...');

      let attempts = 0;
      const maxAttempts = 30;

      const waitForPayPal = setInterval(() => {
        attempts++;

        if (typeof paypal !== 'undefined') {
          console.log('‚úÖ PayPal SDK ready, rendering buttons...');
          clearInterval(waitForPayPal);

          paypal.Buttons({
            createOrder: function(data, actions) {
              console.log('üèóÔ∏è Creating PayPal order...');

              if (!isValid()) {
                console.error('‚ùå Form validation failed');
                showAlert('Molimo ispravite gre≈°ke u formi prije nastavka', 'warning');
                return Promise.reject(new Error('Form validation failed'));
              }

              const orderData = {
                name: document.getElementById('name').value.trim(),
                email: document.getElementById('email').value.trim(),
                shippingAddress: document.getElementById('shippingAddress').value.trim(),
                paymentMethod: 'PAYPAL'
              };

              console.log('üìù Sending order data:', orderData);

              return fetch('/checkout/paypal/create-order', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Accept': 'application/json'
                },
                body: JSON.stringify(orderData)
              })
                      .then(response => {
                        console.log('üì° Response received:', response.status);

                        if (!response.ok) {
                          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        return response.json();
                      })
                      .then(data => {
                        console.log('‚úÖ Order response:', data);

                        if (data.error) {
                          throw new Error(data.error);
                        }

                        if (!data.id && !data.paypalOrderId) {
                          throw new Error('PayPal Order ID not received');
                        }

                        const orderId = data.id || data.paypalOrderId;
                        console.log('üéâ PayPal Order ID:', orderId);
                        return orderId;
                      })
                      .catch(error => {
                        console.error('üí• Create order error:', error);
                        showAlert('Gre≈°ka: ' + error.message, 'danger');
                        throw error;
                      });
            },

            onApprove: function(data, actions) {
              console.log('‚úÖ Payment approved:', data.orderID);

              showAlert('Plaƒáanje odobreno, obraƒëuje se...', 'info');

              return fetch('/checkout/paypal/capture-order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ orderID: data.orderID })
              })
                      .then(response => response.json())
                      .then(data => {
                        console.log('‚úÖ Capture response:', data);

                        if (data.success) {
                          showAlert('Plaƒáanje uspje≈°no! Preusmjeravanje...', 'success');
                          setTimeout(() => {
                            window.location.href = data.redirectUrl || '/checkout/confirmation?orderId=' + data.orderId;
                          }, 1500);
                        } else {
                          throw new Error(data.error || 'Payment capture failed');
                        }
                      })
                      .catch(error => {
                        console.error('üí• Capture error:', error);
                        showAlert('Gre≈°ka pri obradi plaƒáanja: ' + error.message, 'danger');
                      });
            },

            onError: function(err) {
              console.error('‚ùå PayPal error:', err);
              showAlert('PayPal gre≈°ka. Molimo poku≈°ajte ponovo.', 'danger');
            },

            onCancel: function(data) {
              console.log('‚ö†Ô∏è Payment cancelled');
              showAlert('Plaƒáanje je otkazano.', 'warning');
            }

          }).render('#paypal-button-container')
                  .then(() => {
                    console.log('‚úÖ PayPal buttons rendered successfully');
                    paypalRendered = true;
                  })
                  .catch(error => {
                    console.error('‚ùå PayPal render error:', error);
                    showAlert('Gre≈°ka pri uƒçitavanju PayPal dugmeta', 'danger');
                  });

        } else if (attempts >= maxAttempts) {
          console.error('‚ùå PayPal SDK timeout');
          clearInterval(waitForPayPal);
          showAlert('PayPal se nije uƒçitao. Molimo osvje≈æite stranicu.', 'danger');
        } else {
          console.log(`‚è≥ Waiting for PayPal SDK... (${attempts}/${maxAttempts})`);
        }
      }, 1000);
    }

    form.addEventListener('submit', function(e) {
      const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked');

      if (selectedMethod && selectedMethod.value === 'PAYPAL') {
        e.preventDefault();
        showAlert('Koristite PayPal dugme za plaƒáanje', 'warning');
        return;
      }

      if (!isValid()) {
        e.preventDefault();
        showAlert('Molimo ispravite gre≈°ke u formi', 'danger');
        return;
      }
    });

    console.log('‚úÖ FastFruit checkout initialized');
  });
</script>

</body>
</html>