<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="hr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Upravljanje narudžbama</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
</head>
<body>

<!-- Header -->
<div th:replace="~{fragments/header :: header}"></div>

<main class="container my-5">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Upravljanje narudžbama</h1>
    </div>

    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/admin">Nadzorna ploča</a></li>
            <li class="breadcrumb-item active" aria-current="page">Narudžbe</li>
        </ol>
    </nav>

    <!-- Filter Card -->
    <div class="card mb-4 shadow-sm border-0">
        <div class="card-header bg-white">
            <i class="bi bi-funnel me-2"></i> Filtriraj narudžbe
        </div>
        <div class="card-body">
            <form method="get" th:action="@{/admin/orders}" class="row g-3">
                <div class="col-md-3">
                    <label for="username" class="form-label">Korisničko ime</label>
                    <input type="text" class="form-control" id="username" name="username" th:value="${param.username}">
                </div>
                <div class="col-md-3">
                    <label for="startDate" class="form-label">Početni datum</label>
                    <input type="date" class="form-control" id="startDate" name="startDate" th:value="${param.startDate}">
                </div>
                <div class="col-md-3">
                    <label for="endDate" class="form-label">Završni datum</label>
                    <input type="date" class="form-control" id="endDate" name="endDate" th:value="${param.endDate}">
                </div>
                <div class="col-md-3">
                    <label for="paymentMethod" class="form-label">Način plaćanja</label>
                    <select class="form-select" id="paymentMethod" name="paymentMethod">
                        <option value="">Svi načini</option>
                        <option th:each="method : ${paymentMethods}"
                                th:value="${method}"
                                th:text="${method}"
                                th:selected="${param.paymentMethod != null && param.paymentMethod[0] == method}">
                        </option>
                    </select>
                </div>
                <div class="col-12 d-flex justify-content-end gap-2">
                    <a href="/admin/orders" class="btn btn-secondary">Očisti filtere</a>
                    <button type="submit" class="btn btn-primary">Primijeni filtere</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Success/Error Messages -->
    <div th:if="${message}" class="alert alert-success alert-dismissible fade show" role="alert">
        <span th:text="${message}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Zatvori"></button>
    </div>

    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Zatvori"></button>
    </div>

    <!-- Orders Table Card -->
    <div class="card shadow-sm border-0">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <div>
                <i class="bi bi-cart3 me-2"></i> Narudžbe
            </div>
            <div class="badge bg-primary">
                Ukupno: <span th:text="${#lists.size(orders)}">0</span>
            </div>
        </div>
        <div class="card-body">

            <!-- Empty state -->
            <div th:if="${#lists.isEmpty(orders)}" class="text-center py-5">
                <i class="bi bi-cart-x" style="font-size: 3rem; color: #ccc;"></i>
                <h5 class="mt-3 text-muted">Nema narudžbi</h5>
                <p class="text-muted">Nema narudžbi koje odgovaraju odabranim filterima.</p>
            </div>

            <!-- Orders table -->
            <div th:if="${!#lists.isEmpty(orders)}">
                <table id="ordersTable" class="table table-striped table-bordered nowrap" style="width:100%">
                    <thead>
                    <tr>
                        <th>ID narudžbe</th>
                        <th>Korisnik</th>
                        <th>Datum narudžbe</th>
                        <th>Ukupan iznos</th>
                        <th>Način plaćanja</th>
                        <th>Status</th>
                        <th>Akcije</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="order : ${orders}">
                        <td th:text="${order.id}">1</td>
                        <td>
                            <span th:if="${order.user != null}" th:text="${order.user.username}">Username</span>
                            <span th:if="${order.user == null}" class="text-muted">Gost</span>
                        </td>
                        <td>
                            <span th:if="${order.createdAt != null}" th:text="${#temporals.format(order.createdAt, 'yyyy-MM-dd HH:mm')}">2023-01-01 12:00</span>
                            <span th:if="${order.createdAt == null and order.createdAt != null}" th:text="${#temporals.format(order.createdAt, 'yyyy-MM-dd HH:mm')}">2023-01-01 12:00</span>
                            <span th:if="${order.createdAt == null and order.createdAt == null}" class="text-muted">N/A</span>
                        </td>
                        <td th:text="${#numbers.formatDecimal(order.totalAmount, 1, 2)} + ' €'">0.00 €</td>
                        <td>
                            <span th:if="${order.paymentMethod != null}" th:text="${order.paymentMethod}">Payment Method</span>
                            <span th:if="${order.paymentMethod == null}" class="text-muted">N/A</span>
                        </td>
                        <td>
                            <span th:if="${order.status != null}" th:text="${order.status}"
                                  th:classappend="${order.status.name() == 'COMPLETED' ? 'badge bg-success' :
                                                   order.status.name() == 'PENDING' ? 'badge bg-warning text-dark' :
                                                   order.status.name() == 'PROCESSING' ? 'badge bg-info' :
                                                   order.status.name() == 'SHIPPED' ? 'badge bg-primary' :
                                                   order.status.name() == 'DELIVERED' ? 'badge bg-success' :
                                                   order.status.name() == 'CANCELLED' ? 'badge bg-danger' : 'badge bg-secondary'}">STATUS</span>
                            <span th:if="${order.status == null}" class="badge bg-secondary">N/A</span>
                        </td>
                        <td>
                            <a th:href="@{/admin/orders/{id}(id=${order.id})}" class="btn btn-info btn-sm">
                                <i class="bi bi-eye"></i> Detalji
                            </a>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

        </div>
    </div>
</main>

<!-- Footer -->
<div th:replace="~{fragments/footer :: footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/main.js}"></script>
<script>
    $(document).ready(function () {
        if ($('#ordersTable').length) {
            $('#ordersTable').DataTable({
                responsive: true,
                order: [[2, 'desc']],
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/hr.json'
                },
                pageLength: 25,
                lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Sve"]],
                dom: 'Bfrtip',
                columnDefs: [
                    { targets: [6], orderable: false }
                ]
            });
        }
    });
</script>
</body>
</html>